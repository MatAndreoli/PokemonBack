pipeline {
    agent any
    tools {
        maven 'Maven363' 
    }
    environment {
        DATE = new Date().format('yy.M')
        TAG = "${DATE}.${BUILD_NUMBER}"
        DOCKERFILE_PATH = "src/main/docker"
    }
    stages {
        stage('Build Docker Image') {
            steps {
                buildImageTags()
                sh'''
                docker build -f $DOCKERFILE_PATH/Dockerfile.jvm -t $LOCAL_IMG .

                docker tag $LOCAL_IMG $TAG_IMG
                docker tag $LOCAL_IMG $IMG

                docker images
                '''
            }
        }
        stage('Push Image to Docker') {
            steps{
                withCredentials([string(credentialsId: 'docker_hub_secret', variable: 'DOCKER_HUB_CRED')]) {
                    sh 'docker login -u matandreoli -p ${DOCKER_HUB_CRED}'
                    sh 'echo $TAG_IMG'
                }
            }
        }
    }
}


void buildImageTags() {
    sh'''
        python3 get_last_docker_img.py
        export $(grep -v '^#' .env | xargs)
        
        LOCAL_IMG=pokemon-api
        TAG_IMG=matandreoli/pokemon-api:$NEXT_VERSION
        IMG=matandreoli/pokemon-api:latest
    '''
}